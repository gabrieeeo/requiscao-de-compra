<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<section layout:fragment="content">
    <div class="page-header">
        <h2 th:text="'Editar ' + ${requisicao.codigo}">Editar Requisição</h2>
        <a th:href="@{/requisicoes/{id}(id=${requisicao.id})}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Voltar</a>
    </div>

    <form th:action="@{/requisicoes/{id}/editar(id=${requisicao.id})}" th:object="${requisicao}" method="post" id="editForm">
        <div class="form-section">
            <h3>Informações</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Código</label>
                    <input type="text" th:field="*{codigo}" readonly>
                </div>
                <div class="form-group">
                    <label>Departamento *</label>
                    <select th:field="*{departamento}" required>
                        <option th:each="dep : ${departamentos}" th:value="${dep}" th:text="${dep}"></option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Prazo *</label>
                    <input type="date" th:field="*{prazoEntrega}" required>
                </div>
            </div>
            <div class="form-group full-width">
                <label>Finalidade *</label>
                <textarea th:field="*{finalidadeDaCompra}" rows="3" required></textarea>
            </div>
            <div class="form-group full-width">
                <label>Pedido de Compra</label>
                <input type="text" th:field="*{pedidoDeCompra}" placeholder="Opcional">
            </div>
        </div>

        <div class="form-section">
            <h3>Itens</h3>
            <div id="itens-container">
                <div class="item-row" th:each="item,iter : *{itens}" th:attr="data-item-index=${iter.index}">
                    <div class="form-group">
                        <label>Item *</label>
                        <input type="text" th:name="${'itens[' + iter.index + '].nome'}" th:value="${item.nome}" required>
                    </div>
                    <div class="form-group">
                        <label>Qtd *</label>
                        <input type="number" min="1" th:name="${'itens[' + iter.index + '].quantidade'}" th:value="${item.quantidade}" required>
                    </div>
                    <div class="form-group">
                        <label>Unidade</label>
                        <input type="text" th:name="${'itens[' + iter.index + '].unidadeMedida'}" th:value="${item.unidadeMedida}">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-danger btn-sm" th:onclick="|removerItem(${iter.index})|"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-secondary" onclick="adicionarItem()"><i class="fas fa-plus"></i> Adicionar Item</button>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Alterações</button>
        </div>
    </form>

    <script>
        let itemIndex = document.querySelectorAll('#itens-container .item-row').length;
        function adicionarItem() {
            const container = document.getElementById('itens-container');
            const div = document.createElement('div');
            div.className = 'item-row';
            div.setAttribute('data-item-index', itemIndex);
            div.innerHTML = `
                <div class="form-group">
                    <label>Item *</label>
                    <input type="text" name="itens[${itemIndex}].nome" required>
                </div>
                <div class="form-group">
                    <label>Qtd *</label>
                    <input type="number" name="itens[${itemIndex}].quantidade" min="1" required>
                </div>
                <div class="form-group">
                    <label>Unidade</label>
                    <input type="text" name="itens[${itemIndex}].unidadeMedida">
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removerItem(${itemIndex})"><i class="fas fa-trash"></i></button>
                </div>`;
            container.appendChild(div);
            itemIndex++;
        }
        function removerItem(i) {
            const row = document.querySelector(`[data-item-index='${i}']`);
            if (row) row.remove();
        }
    </script>
</section>
</html>