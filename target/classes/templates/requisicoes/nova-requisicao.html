<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" 
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<section layout:fragment="content">
    <div class="page-header">
        <h2>Nova Requisição de Compra</h2>
        <a href="/requisicoes" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>

    <form th:action="@{/requisicoes}" th:object="${requisicao}" method="post" class="form" id="requisicaoForm">
        <div class="form-section">
            <h3>Informações Básicas</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="departamento">Departamento *</label>
                    <select id="departamento" th:field="*{departamento}" required>
                        <option value="">Selecione o departamento</option>
                        <option th:each="dep : ${departamentos}" th:value="${dep}" th:text="${dep.descricao}"></option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="prazoEntrega">Prazo de Entrega *</label>
                    <input type="date" id="prazoEntrega" th:field="*{prazoEntrega}" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="finalidadeDaCompra">Finalidade *</label>
                    <textarea id="finalidadeDaCompra" th:field="*{finalidadeDaCompra}" required placeholder="Descreva a finalidade da requisição" rows="3"></textarea>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Itens da Requisição</h3>
            <small>Pelo menos um item é obrigatório.</small>
            <div id="itens-container">
                <div class="item-row" data-item-index="0">
                    <div class="form-group">
                        <label>Item *</label>
                        <input type="text" name="itens[0].nome" required placeholder="Nome do item">
                    </div>
                    <div class="form-group">
                        <label>Quantidade *</label>
                        <input type="number" name="itens[0].quantidade" required min="1" placeholder="Qtd">
                    </div>
                    <div class="form-group">
                        <label>Unidade</label>
                        <input type="text" name="itens[0].unidadeMedida" placeholder="Ex: UN, KG">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removerItem(0)" style="display: none;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-secondary" onclick="adicionarItem()"><i class="fas fa-plus"></i> Adicionar Item</button>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="window.location.href='/requisicoes'">Cancelar</button>
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Requisição</button>
        </div>
    </form>

    <script>
        let itemIndex = 1;

        function adicionarItem() {
            const container = document.getElementById('itens-container');
            const newItem = document.createElement('div');
            newItem.className = 'item-row';
            newItem.setAttribute('data-item-index', itemIndex);
            newItem.innerHTML = `
                <div class="form-group">
                    <label>Item *</label>
                    <input type="text" name="itens[${itemIndex}].nome" required placeholder="Nome do item">
                </div>
                <div class="form-group">
                    <label>Quantidade *</label>
                    <input type="number" name="itens[${itemIndex}].quantidade" required min="1" placeholder="Qtd">
                </div>
                <div class="form-group">
                    <label>Unidade</label>
                    <input type="text" name="itens[${itemIndex}].unidadeMedida" placeholder="Ex: UN, CX">
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removerItem(${itemIndex})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>`;
            container.appendChild(newItem);
            itemIndex++;
            atualizarBotoesRemover();
        }

        function removerItem(index) {
            const row = document.querySelector(`[data-item-index="${index}"]`);
            if (row) {
                row.remove();
                atualizarBotoesRemover();
            }
        }

        function atualizarBotoesRemover() {
            const rows = document.querySelectorAll('.item-row');
            rows.forEach(r => {
                const btn = r.querySelector('.btn-danger');
                btn.style.display = rows.length > 1 ? 'block' : 'none';
            });
        }

        document.getElementById('requisicaoForm').addEventListener('submit', e => {
            const departamento = document.getElementById('departamento').value;
            const finalidade = document.getElementById('finalidadeDaCompra').value.trim();
            const prazo = document.getElementById('prazoEntrega').value;
            if (!departamento || !finalidade || !prazo) {
                e.preventDefault();
                alert('Preencha os campos obrigatórios.');
                return;
            }
            const itens = document.querySelectorAll('#itens-container input[name$=".nome"]');
            const valid = Array.from(itens).some(i => i.value.trim());
            if (!valid) {
                e.preventDefault();
                alert('Informe ao menos um item.');
            }
        });
    </script>
</section>
</html>